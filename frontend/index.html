<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫—É—Ä–æ—Ä—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 8px 0 rgba(0,0,0,0.12), 0 12px 20px rgba(0,0,0,0.10);
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 0 rgba(0,0,0,0.18), 0 8px 14px rgba(0,0,0,0.15);
            filter: brightness(0.97);
        }

        .btn:focus-visible {
            outline: 3px solid rgba(79, 172, 254, 0.5);
            outline-offset: 2px;
        }

        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            filter: grayscale(0.1);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .progress-section {
            margin: 30px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            color: #6c757d;
            font-weight: 500;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .cache-info {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }

        .cache-entry {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            max-width: 520px;
            width: calc(100% - 40px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: #fff;
            font-weight: 700;
        }
        .modal-body { padding: 18px 20px; color: #333; }
        .modal-footer { padding: 12px 16px; text-align: right; background: #f7f7f7; }
        .modal-btn { padding: 10px 18px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .modal-btn-primary { background: #4facfe; color: #fff; }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group input {
                min-width: auto;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèñÔ∏è –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫—É—Ä–æ—Ä—Ç–æ–≤</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>üìç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞</h2>
                <div class="input-group">
                    <input type="text" id="locationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏, –ê–Ω–∞–ø–∞, –ì–µ–ª–µ–Ω–¥–∂–∏–∫..." maxlength="100">
                    <button class="btn btn-secondary" onclick="getNamesList()">
                        üè® –ù–∞–π—Ç–∏ –æ—Ç–µ–ª–∏
                    </button>
                </div>
            </div>

            <div class="progress-section" id="progressSection">
                <h3>‚è≥ –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            </div>

            <div class="export-section" id="exportSection">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã!</h3>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>

            

            <div class="results-section" id="resultsSection">
                <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∞</h3>
                <div class="table-container">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–¢–∏–ø</th>
                                <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
                                <th>–ê–¥—Ä–µ—Å</th>
                                <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="results-section" id="namesSection" style="display:none;">
                <h3>üìã –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                <div id="namesContainer" style="margin-top:10px;">
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
            </div>

            <div class="export-section" id="namesExportSection" style="display:none;">
                <h3>üìä –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ç–æ–≤</h3>
                <button id="namesExportBtn" class="btn btn-secondary" onclick="exportNamesToExcel()">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>

            <div class="log-section" id="logSection">
                <h3>üìù –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞</h3>
                <div id="logContainer">
                    <div class="log-entry log-info">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –æ—Ç–µ–ª–∏".</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="hideModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalTitle">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="hideModal()">–û–ö</button>
            </div>
        </div>
    </div>

    <script>
        let currentLocation = '';
        let isCollecting = false;
        let currentNames = [];

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showModal(title, message) {
            const backdrop = document.getElementById('modalBackdrop');
            const t = document.getElementById('modalTitle');
            const b = document.getElementById('modalBody');
            t.textContent = title || '–°–æ–æ–±—â–µ–Ω–∏–µ';
            b.textContent = message || '';
            backdrop.style.display = 'flex';
        }
        function hideModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'none';
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
        }

        function showExport() {
            document.getElementById('exportSection').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('resultsBody').innerHTML = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
        }

        function startCollection() {
            const location = document.getElementById('locationInput').value.trim();
            
            if (!location) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞');
                return;
            }

            if (isCollecting) {
                alert('–°–±–æ—Ä —É–∂–µ –∏–¥–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ');
                return;
            }

            currentLocation = location;
            isCollecting = true;
            
            clearResults();
            showProgress();
            addLog(`–ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è: ${location}`, 'info');
            
            updateProgress(10, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–±–æ—Ä—É...');
            
            collectContacts();
        }

        async function collectContacts() {
            try {
                updateProgress(20, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                addLog('–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'info');

                const response = await fetch('http://127.0.0.1:8001/collect-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        location: currentLocation
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                updateProgress(80, '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');
                addLog('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...', 'success');

                const data = await response.json();
                
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                addLog(`–°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–π–¥–µ–Ω–æ ${data.contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`, 'success');

                displayResults(data.contacts);
                showResults();
                showExport();
                
                setTimeout(() => {
                    hideProgress();
                }, 1000);

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            } finally {
                isCollecting = false;
            }
        }

        function displayResults(contacts) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${contact.name || '-'}</td>
                    <td>${contact.type || '-'}</td>
                    <td>${contact.contact || '-'}</td>
                    <td>${contact.address || '-'}</td>
                    <td>${contact.coordinates || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function exportToExcel() {
            try {
                addLog('–ù–∞—á–∏–Ω–∞—é —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel...', 'info');
                
                const response = await fetch(`http://127.0.0.1:8001/export-excel/${encodeURIComponent(currentLocation)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–∫–æ–Ω—Ç–∞–∫—Ç—ã_${currentLocation}_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                addLog('–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            }
        }

        async function getNamesList() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞');
                return;
            }
            addLog(`–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è: ${location}`, 'info');
            try {
                currentLocation = location;
                document.getElementById('namesSection').style.display = 'none';
                document.getElementById('namesExportSection').style.display = 'none';
                showProgress();
                updateProgress(15, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–∏—Å–∫—É –Ω–∞–∑–≤–∞–Ω–∏–π...');
                const resp = await fetch('http://127.0.0.1:8001/list-names', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({ location })
                });
                if (!resp.ok) {
                    try { hideProgress(); } catch {}
                    if (resp.status === 404) {
                        addLog('–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
                        showModal('–ù–µ –Ω–∞–π–¥–µ–Ω–æ', '–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        return;
                    }
                    const txt = await resp.text().catch(() => '');
                    addLog(`–û—à–∏–±–∫–∞: ${resp.status}. ${txt}`, 'error');
                    showModal('–û—à–∏–±–∫–∞', `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ (${resp.status}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
                    return;
                }
                updateProgress(60, '–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Ñ–æ—Ä–º–∏—Ä—É—é —Å–ø–∏—Å–æ–∫...');
                const data = await resp.json();
                const names = Array.isArray(data.names) ? data.names : [];
                const exportBtn = document.getElementById('namesExportBtn');
                showNames(names);
                if (names.length === 0) {
                    addLog('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.', 'warning');
                    showModal('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –≤–æ–∑–º–æ–∂–Ω–æ —Ç–∞–∫–æ–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                    document.getElementById('namesExportSection').style.display = 'none';
                    if (exportBtn) exportBtn.disabled = true;
                } else {
                    addLog(`–ü–æ–ª—É—á–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–π: ${names.length}`, 'success');
                    document.getElementById('namesExportSection').style.display = 'block';
                    if (exportBtn) exportBtn.disabled = false;
                }
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                setTimeout(hideProgress, 800);
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π: ${e.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(hideProgress, 1200);
            }
        }

        function showNames(names) {
            const section = document.getElementById('namesSection');
            const container = document.getElementById('namesContainer');
            if (!Array.isArray(names) || names.length === 0) {
                container.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                section.style.display = 'block';
                return;
            }
            currentNames = names.slice();
            let html = '<ol style="padding-left:20px;">';
            names.forEach((n) => {
                const safe = String(n).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                html += `<li style="margin:6px 0;">${safe}</li>`;
            });
            html += '</ol>';
            container.innerHTML = html;
            section.style.display = 'block';
        }

        async function exportNamesToExcel() {
            try {
                addLog('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≤ Excel...', 'info');
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –±—ç–∫–µ–Ω–¥-—ç–Ω–¥–ø–æ–∏–Ω—Ç (xlsx)
                const url = `http://127.0.0.1:8001/export-names-excel/${encodeURIComponent(currentLocation)}`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const blob = await resp.blob();
                    const dlUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = dlUrl;
                    a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(dlUrl);
                    document.body.removeChild(a);
                    addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (xlsx)', 'success');
                    return;
                }
                // –§–æ–ª–±—ç–∫: —Å–æ–∑–¥–∞—ë–º CSV –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ Excel)
                const bom = '\ufeff';
                const header = 'name\n';
                const rows = (currentNames || []).map(n => String(n).replace(/\n/g, ' ').replace(/\r/g, ' ')).join('\n');
                const csv = bom + header + rows + '\n';
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const dlUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(dlUrl);
                document.body.removeChild(a);
                addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (CSV —Ñ–æ–ª–±—ç–∫)', 'success');
            } catch (e) {
                // –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ —Ç–∞–∫–∂–µ –æ—Ç–¥–∞—ë–º CSV-—Ñ–æ–ª–±—ç–∫
                try {
                    const bom = '\\ufeff';
                    const header = 'name\\n';
                    const rows = (currentNames || []).map(n => String(n).replace(/\\n/g, ' ').replace(/\\r/g, ' ')).join('\\n');
                    const csv = bom + header + rows + '\\n';
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const dlUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = dlUrl;
                    a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(dlUrl);
                    document.body.removeChild(a);
                    addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (CSV —Ñ–æ–ª–±—ç–∫)', 'success');
                } catch (err) {
                    addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏–π: ${err.message}`, 'error');
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–π: ' + err.message);
                }
            }
        }

    </script>
</body>
</html>
