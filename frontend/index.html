<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫—É—Ä–æ—Ä—Ç–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            min-width: 300px;
            padding: 15px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 8px 0 rgba(0,0,0,0.12), 0 12px 20px rgba(0,0,0,0.10);
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 0 rgba(0,0,0,0.18), 0 8px 14px rgba(0,0,0,0.15);
            filter: brightness(0.97);
        }

        .btn:focus-visible {
            outline: 3px solid rgba(79, 172, 254, 0.5);
            outline-offset: 2px;
        }

        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
            filter: grayscale(0.1);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
        }

        .progress-section {
            margin: 30px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            color: #6c757d;
            font-weight: 500;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .export-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .cache-info {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
        }

        .cache-entry {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            max-width: 520px;
            width: calc(100% - 40px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .modal-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
            color: #fff;
            font-weight: 700;
        }
        .modal-body { padding: 18px 20px; color: #333; }
        .modal-footer { padding: 12px 16px; text-align: right; background: #f7f7f7; }
        .modal-btn { padding: 10px 18px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .modal-btn-primary { background: #4facfe; color: #fff; }

        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –°—Ç–æ–ø */
        .fixed-stop-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            display: none;
        }

        .fixed-stop-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.6);
        }

        .fixed-stop-button:active {
            transform: translateY(0);
        }

        .fixed-stop-button[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.2);
        }

        /* –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ */
        .process-message {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
            display: none;
        }

        /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π */
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
        .results-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-group input {
                min-width: auto;
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèñÔ∏è –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∫—É—Ä–æ—Ä—Ç–æ–≤</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>üìç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞</h2>
                <div class="input-group">
                    <input type="text" id="locationInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏, –ê–Ω–∞–ø–∞, –ì–µ–ª–µ–Ω–¥–∂–∏–∫..." maxlength="100">
                    <button class="btn btn-secondary" onclick="getNamesList()">
                        üè® –ù–∞–π—Ç–∏ –æ—Ç–µ–ª–∏
                    </button>
                    <button class="btn btn-secondary" onclick="clearCacheForCurrentLocation()" title="–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
                    </button>
                </div>
            </div>

            <div class="progress-section" id="progressSection">
                <h3>‚è≥ –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            </div>

            <div class="export-section" id="exportSection">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã!</h3>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </button>
            </div>

            

            <div class="results-section" id="resultsSection">
                <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∞</h3>
                <div class="table-container">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–¢–∏–ø</th>
                                <th>–ö–æ–Ω—Ç–∞–∫—Ç</th>
                                <th>–ê–¥—Ä–µ—Å</th>
                                <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="results-section" id="namesSection" style="display:none;">
                <h3>üìã –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                <div id="namesContainer" style="margin-top:10px;">
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
                <div id="namesReadyNote" class="progress-text" style="margin-top:10px; display:none;">üìä –°–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ç–æ–≤</div>
            </div>

            <div class="results-section" id="websitesSection" style="display:none;">
                <h3>üîó –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: —Å–∞–π—Ç—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç</th>
                                <th>Email</th>
                                <th>–ê–¥—Ä–µ—Å</th>
                            </tr>
                        </thead>
                        <tbody id="websitesBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
            <div class="process-message" id="processMessage">
                üöÄ –ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω...
            </div>

            <div class="export-section" id="namesExportSection" style="display:none;">
                <div id="websitesSummary" class="progress-text" style="margin:6px 0 10px 0; display:none;"></div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="namesExportBtn" class="btn btn-secondary btn-small" onclick="exportNamesWithSitesExcel()">
                        üì• –≠–∫—Å–ø–æ—Ä—Ç (Excel)
                    </button>
                    <button id="findWebsitesBtn" class="btn btn-primary btn-small" onclick="findWebsitesSequential()">
                        üîó –ù–∞–π—Ç–∏ —Å–∞–π—Ç—ã
                    </button>
                    <button id="extractContactsBtn" class="btn btn-primary btn-small" onclick="extractContactsSequential()" style="display:none;">
                        üìß –ò–∑–≤–ª–µ—á—å –∫–æ–Ω—Ç–∞–∫—Ç—ã
                    </button>
                    <button id="stopWebsitesBtn" class="btn btn-secondary btn-small" onclick="stopAllProcesses()" disabled>
                        ‚õî –°—Ç–æ–ø
                    </button>
                </div>
            </div>

            <div class="log-section" id="logSection">
                <h3>üìù –õ–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞</h3>
                <div id="logContainer">
                    <div class="log-entry log-info">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞–π—Ç–∏ –æ—Ç–µ–ª–∏".</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="hideModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header" id="modalTitle">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="hideModal()">–û–ö</button>
            </div>
        </div>
    </div>

    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –°—Ç–æ–ø -->
    <button class="fixed-stop-button" id="fixedStopBtn" onclick="stopAllProcesses()" disabled>
        ‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
    </button>

    <script>
        let currentLocation = '';
        let isCollecting = false;
        let currentNames = [];
        let currentWebsiteItems = [];
        let stopFinding = false;
        let currentContacts = []; // —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ name -> { website, email, address }
        let activeController = null; // AbortController –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ fetch
        let activeProcess = null;    // 'names' | 'websites' | 'contacts' | null
        let processMsg = null;       // —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø—Ä–æ—Ü–µ—Å—Å–µ

        function beginProcess(kind) {
            activeProcess = kind;
            stopFinding = false;
            if (activeController) {
                try { activeController.abort(); } catch {}
            }
            activeController = null;
            const stopBtn = document.getElementById('stopWebsitesBtn');
            const fixedStopBtn = document.getElementById('fixedStopBtn');
            if (stopBtn) stopBtn.disabled = false;
            if (fixedStopBtn) {
                fixedStopBtn.disabled = false;
                fixedStopBtn.style.display = 'block';
            }
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
            const exportBtn = document.getElementById('namesExportBtn');
            if (exportBtn) exportBtn.disabled = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
            if (kind === 'contacts') {
                processMsg = document.getElementById('processMessage');
                if (processMsg) {
                    processMsg.style.display = 'block';
                    processMsg.textContent = 'üöÄ –ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω...';
                }
            }
        }
        function endProcess() {
            activeProcess = null;
            if (activeController) {
                try { activeController.abort(); } catch {}
            }
            activeController = null;
            const stopBtn = document.getElementById('stopWebsitesBtn');
            const fixedStopBtn = document.getElementById('fixedStopBtn');
            if (stopBtn) stopBtn.disabled = true;
            if (fixedStopBtn) {
                fixedStopBtn.disabled = true;
                fixedStopBtn.style.display = 'none';
            }
            // –†–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
            const exportBtn = document.getElementById('namesExportBtn');
            if (exportBtn) exportBtn.disabled = false;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
            processMsg = document.getElementById('processMessage');
            if (processMsg) {
                processMsg.style.display = 'none';
            }
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function showModal(title, message) {
            const backdrop = document.getElementById('modalBackdrop');
            const t = document.getElementById('modalTitle');
            const b = document.getElementById('modalBody');
            t.textContent = title || '–°–æ–æ–±—â–µ–Ω–∏–µ';
            b.textContent = message || '';
            backdrop.style.display = 'flex';
        }
        function hideModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(percent, text) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        function showProgress() {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'none';
            const stopBtn = document.getElementById('stopWebsitesBtn');
            if (stopBtn) stopBtn.disabled = false;
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
            const stopBtn = document.getElementById('stopWebsitesBtn');
            if (stopBtn) stopBtn.disabled = true;
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
        }

        function showExport() {
            document.getElementById('exportSection').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('resultsBody').innerHTML = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
        }

        function clearWebsites() {
            try {
                currentWebsiteItems = [];
                currentContacts = [];
                const tbody = document.getElementById('websitesBody');
                if (tbody) tbody.innerHTML = '';
                const section = document.getElementById('websitesSection');
                if (section) section.style.display = 'none';
                // –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –µ–¥–∏–Ω–∞—è: —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
            } catch {}
        }

        function startCollection() {
            const location = document.getElementById('locationInput').value.trim();
            
            if (!location) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞');
                return;
            }

            if (isCollecting) {
                alert('–°–±–æ—Ä —É–∂–µ –∏–¥–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ');
                return;
            }

            currentLocation = location;
            isCollecting = true;
            
            clearResults();
            showProgress();
            addLog(`–ù–∞—á–∏–Ω–∞—é —Å–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–ª—è: ${location}`, 'info');
            
            updateProgress(10, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–±–æ—Ä—É...');
            
            collectContacts();
        }

        async function collectContacts() {
            try {
                updateProgress(20, '–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
                addLog('–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', 'info');

                const response = await fetch('http://127.0.0.1:8001/collect-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({
                        location: currentLocation
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                updateProgress(80, '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');
                addLog('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...', 'success');

                const data = await response.json();
                
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                addLog(`–°–±–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω! –ù–∞–π–¥–µ–Ω–æ ${data.contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤`, 'success');

                displayResults(data.contacts);
                showResults();
                showExport();
                
                setTimeout(() => {
                    hideProgress();
                }, 1000);

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(() => {
                    hideProgress();
                }, 2000);
            } finally {
                isCollecting = false;
            }
        }

        function displayResults(contacts) {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';

            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${contact.name || '-'}</td>
                    <td>${contact.type || '-'}</td>
                    <td>${contact.contact || '-'}</td>
                    <td>${contact.address || '-'}</td>
                    <td>${contact.coordinates || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function exportToExcel() {
            try {
                addLog('–ù–∞—á–∏–Ω–∞—é —ç–∫—Å–ø–æ—Ä—Ç –≤ Excel...', 'info');
                
                const response = await fetch(`http://127.0.0.1:8001/export-excel/${encodeURIComponent(currentLocation)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–∫–æ–Ω—Ç–∞–∫—Ç—ã_${currentLocation}_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                addLog('–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            }
        }

        async function getNamesList() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
            addLog(`–ü—Ä–æ–≤–µ—Ä—è—é –∫—ç—à –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'info');
            const cacheStatus = await checkCacheStatus(location);
            
            if (cacheStatus && cacheStatus.location_match) {
                addLog(`–ù–∞–π–¥–µ–Ω –∫—ç—à –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'success');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                loadCacheDataToUI();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø
                const nextStage = getNextStageFromCache();
                addLog(`–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: ${nextStage}`, 'info');
                
                // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
                if (cacheStatus.process_status.names_found && currentCacheData && currentCacheData.organizations) {
                    const names = currentCacheData.organizations.map(org => org.name).filter(name => name);
                    if (names.length > 0) {
                        currentNames = names; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                        showNames(names);
                        addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${names.length} –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ –∫—ç—à–∞`, 'success');
                        
                        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
                        if (cacheStatus.process_status.websites_found) {
                            // –ï—Å–ª–∏ —Å–∞–π—Ç—ã —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–∑–≤–ª–µ—á—å –∫–æ–Ω—Ç–∞–∫—Ç—ã"
                            const extractBtn = document.getElementById('extractContactsBtn');
                            if (extractBtn) {
                                extractBtn.style.display = 'inline-block';
                                extractBtn.disabled = false;
                            }
                        } else {
                            // –ï—Å–ª–∏ —Å–∞–π—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–π—Ç–∏ —Å–∞–π—Ç—ã"
                            const findBtn = document.getElementById('findWebsitesBtn');
                            if (findBtn) {
                                findBtn.style.display = 'inline-block';
                                findBtn.disabled = false;
                            }
                        }
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
                        const websitesSection = document.getElementById('websitesSection');
                        if (websitesSection) {
                            websitesSection.style.display = 'block';
                        }
                        return;
                    }
                }
            } else {
                addLog(`–ö—ç—à –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞—é –ø–æ–∏—Å–∫ —Å –Ω—É–ª—è`, 'info');
            }
            
            addLog(`–ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –¥–ª—è: ${location}`, 'info');
            try {
                currentLocation = location;
                document.getElementById('namesSection').style.display = 'none';
                document.getElementById('namesExportSection').style.display = 'none';
                const sum = document.getElementById('websitesSummary');
                if (sum) { sum.style.display = 'none'; sum.textContent = ''; }
                // –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∞–π—Ç–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–º –ø–æ–∏—Å–∫–µ –Ω–∞–∑–≤–∞–Ω–∏–π
                clearWebsites();
                showProgress();
                updateProgress(15, '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–æ–∏—Å–∫—É –Ω–∞–∑–≤–∞–Ω–∏–π...');
                beginProcess('names');
                activeController = new AbortController();
                const resp = await fetch('http://127.0.0.1:8001/list-names', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify({ location }),
                    signal: activeController.signal
                });
                if (!resp.ok) {
                    try { hideProgress(); } catch {}
                    if (resp.status === 404) {
                        addLog('–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
                        showModal('–ù–µ –Ω–∞–π–¥–µ–Ω–æ', '–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                        return;
                    }
                    const txt = await resp.text().catch(() => '');
                    addLog(`–û—à–∏–±–∫–∞: ${resp.status}. ${txt}`, 'error');
                    showModal('–û—à–∏–±–∫–∞', `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ (${resp.status}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`);
                    return;
                }
                updateProgress(60, '–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç, —Ñ–æ—Ä–º–∏—Ä—É—é —Å–ø–∏—Å–æ–∫...');
                const data = await resp.json();
                const names = Array.isArray(data.names) ? data.names : [];
                const exportBtn = document.getElementById('namesExportBtn');
                showNames(names);
                if (names.length === 0) {
                    addLog('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.', 'warning');
                    showModal('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞, –≤–æ–∑–º–æ–∂–Ω–æ —Ç–∞–∫–æ–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
                    document.getElementById('namesExportSection').style.display = 'none';
                    if (exportBtn) exportBtn.disabled = true;
                } else {
                    addLog(`–ü–æ–ª—É—á–µ–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–π: ${names.length}`, 'success');
                    document.getElementById('namesExportSection').style.display = 'block';
                    // —Ç–∞–±–ª–∏—Ü–∞ —Å–∞–π—Ç–æ–≤ –ø–æ–∫–∞ —Å–∫—Ä—ã—Ç–∞, –¥–æ —Å—Ç–∞—Ä—Ç–∞ –ø–æ–∏—Å–∫–∞ —Å–∞–π—Ç–æ–≤
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
                    const organizations = names.map(name => ({
                        name: name,
                        website: '',
                        email: '',
                        address: ''
                    }));
                    await updateCache(location, 'names', 'completed', organizations);
                }
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                setTimeout(hideProgress, 800);
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π: ${e.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(hideProgress, 1200);
            } finally {
                endProcess();
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                const exportBtn = document.getElementById('namesExportBtn');
                if (exportBtn && Array.isArray(currentNames) && currentNames.length > 0) {
                    exportBtn.disabled = false;
                }
                activeController = null;
                isCollecting = false;
            }
        }

        function showNames(names) {
            const section = document.getElementById('namesSection');
            const container = document.getElementById('namesContainer');
            const ready = document.getElementById('namesReadyNote');
            if (!Array.isArray(names) || names.length === 0) {
                container.innerHTML = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                section.style.display = 'block';
                if (ready) ready.style.display = 'none';
                return;
            }
            currentNames = names.slice();
            let html = '<ol style="padding-left:20px;">';
            names.forEach((n) => {
                const safe = String(n).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                html += `<li style="margin:6px 0;">${safe}</li>`;
            });
            html += '</ol>';
            container.innerHTML = html;
            section.style.display = 'block';
            if (ready) ready.style.display = 'block';
        }

        async function exportNamesToExcel() {
            try {
                addLog('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≤ Excel...', 'info');
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –±—ç–∫–µ–Ω–¥-—ç–Ω–¥–ø–æ–∏–Ω—Ç (xlsx)
                const url = `http://127.0.0.1:8001/export-names-excel/${encodeURIComponent(currentLocation)}`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const blob = await resp.blob();
                    const dlUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = dlUrl;
                    a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(dlUrl);
                    document.body.removeChild(a);
                    addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (xlsx)', 'success');
                    return;
                }
                // –§–æ–ª–±—ç–∫: —Å–æ–∑–¥–∞—ë–º CSV –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ Excel)
                const bom = '\ufeff';
                const header = 'name\n';
                const rows = (currentNames || []).map(n => String(n).replace(/\n/g, ' ').replace(/\r/g, ' ')).join('\n');
                const csv = bom + header + rows + '\n';
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const dlUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(dlUrl);
                document.body.removeChild(a);
                addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (CSV —Ñ–æ–ª–±—ç–∫)', 'success');
            } catch (e) {
                // –ü—Ä–∏ —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–µ —Ç–∞–∫–∂–µ –æ—Ç–¥–∞—ë–º CSV-—Ñ–æ–ª–±—ç–∫
                try {
                    const bom = '\\ufeff';
                    const header = 'name\\n';
                    const rows = (currentNames || []).map(n => String(n).replace(/\\n/g, ' ').replace(/\\r/g, ' ')).join('\\n');
                    const csv = bom + header + rows + '\\n';
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const dlUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = dlUrl;
                    a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation}_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(dlUrl);
                    document.body.removeChild(a);
                    addLog('–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–∑–≤–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à—ë–Ω (CSV —Ñ–æ–ª–±—ç–∫)', 'success');
                } catch (err) {
                    addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏–π: ${err.message}`, 'error');
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–π: ' + err.message);
                }
            }
        }

        async function exportNamesWithSitesExcel() {
            try {
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Å–∞–π—Ç—ã ‚Äî —à–ª—ë–º POST –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ name+website
                let items = [];
                if (Array.isArray(currentWebsiteItems) && currentWebsiteItems.length > 0) {
                    items = currentWebsiteItems.map(it => {
                        // –Ω–∞–π–¥—ë–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ –∏–º–µ–Ω–∏
                        let c = null;
                        if (Array.isArray(currentContacts) && currentContacts.length > 0) {
                            c = currentContacts.find(x => String(x.name||'') === String(it.name||'')) || null;
                        }
                        return {
                            name: String(it.name||''),
                            website: String(it.website||''),
                            email: c && c.email ? String(c.email||'') : '',
                            address: c && c.address ? String(c.address||'') : ''
                        };
                    });
                } else {
                    items = (currentNames||[]).map(n => ({ name: String(n||''), website: '', email: '', address: '' }));
                }
                const resp = await fetch('http://127.0.0.1:8001/export-names-excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8', 'Accept': 'application/json; charset=utf-8' },
                    body: JSON.stringify({ location: currentLocation||'', items })
                });
                if (!resp.ok) {
                    const txt = await resp.text().catch(()=>'');
                    throw new Error(`HTTP ${resp.status}: ${txt}`);
                }
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `–Ω–∞–∑–≤–∞–Ω–∏—è_${currentLocation || '–≥–æ—Ä–æ–¥'}_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(a);
                addLog('–≠–∫—Å–ø–æ—Ä—Ç (–∏–º–µ–Ω–∞+—Å–∞–π—Ç—ã) –∑–∞–≤–µ—Ä—à—ë–Ω (xlsx)', 'success');
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${e.message}`, 'error');
            }
        }

        async function findWebsitesSequential() {
            const location = currentLocation;
            if (!location) {
                showModal('–ù–µ—Ç –≥–æ—Ä–æ–¥–∞', '–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π.');
                return;
            }
            if (!Array.isArray(currentNames) || currentNames.length === 0) {
                showModal('–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–π', '–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π (–ù–∞–π—Ç–∏ –æ—Ç–µ–ª–∏).');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –¥–ª—è —Å–∞–π—Ç–æ–≤
            const cacheStatus = await checkCacheStatus(location);
            if (cacheStatus && cacheStatus.location_match && cacheStatus.process_status.websites_found) {
                addLog(`–°–∞–π—Ç—ã —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫—ç—à–µ –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'success');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∞–π—Ç—ã –∏–∑ –∫—ç—à–∞
                if (currentCacheData && currentCacheData.organizations) {
                    const websites = currentCacheData.organizations
                        .filter(org => org.website && org.website !== '')
                        .map(org => ({ name: org.name, website: org.website }));
                    
                    if (websites.length > 0) {
                        showWebsites(websites);
                        addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${websites.length} —Å–∞–π—Ç–æ–≤ –∏–∑ –∫—ç—à–∞`, 'success');
                        return;
                    }
                }
            }
            
            try {
                addLog(`–ó–∞–ø—É—Å–∫–∞—é –ø–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ –¥–ª—è ${currentNames.length} –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ ${location}...`, 'info');
                // –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ç–∞–±–ª–∏—Ü—É —Å–∞–π—Ç–æ–≤ –¥–æ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
                clearWebsites();
                const findBtn = document.getElementById('findWebsitesBtn');
                const stopBtn = document.getElementById('stopWebsitesBtn');
                if (findBtn) findBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                stopFinding = false;
                activeController = null;
                showProgress();
                const summary = document.getElementById('websitesSummary');
                if (summary) { summary.style.display = 'none'; summary.textContent = ''; }
                const total = currentNames.length;
                let aggregated = [];
                let interrupted = false;
                activeProcess = 'websites';
                for (let i = 0; i < total; i++) {
                    if (stopFinding) { addLog('–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning'); interrupted = true; break; }
                    const name = currentNames[i];
                    const pct = Math.round(((i) / total) * 100 * 0.9) + 10;
                    updateProgress(Math.min(95, Math.max(15, pct)), `–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤... ${i + 1}/${total}`);
                    activeController = new AbortController();
                    try {
                        const resp = await fetch('http://127.0.0.1:8001/find-websites', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json; charset=utf-8',
                                'Accept': 'application/json; charset=utf-8',
                            },
                            body: JSON.stringify({ location, names: [name] }),
                            signal: activeController.signal
                        });
                        if (!resp.ok) {
                            const txt = await resp.text().catch(() => '');
                            addLog(`–û—à–∏–±–∫–∞ ${i + 1}: HTTP ${resp.status}: ${txt}`, 'warning');
                            interrupted = true;
                        } else {
                            const data = await resp.json();
                            // –í—ã–≤–µ–¥–µ–º backend-–ª–æ–≥–∏ (–≤–∫–ª—é—á–∞—è YANDEX DBG)
                            try {
                                if (Array.isArray(data.logs)) {
                                    for (const line of data.logs.slice(-40)) {
                                        const t = (typeof line === 'string' ? line : JSON.stringify(line));
                                        const type = t.includes('‚ö†Ô∏è') || t.includes('–û—à–∏–±–∫–∞') ? 'warning' : (t.includes('‚úÖ') || t.includes('üü¢') ? 'success' : 'info');
                                        addLog(t, type);
                                    }
                                }
                            } catch {}
                            const items = Array.isArray(data.items) ? data.items : [];
                            aggregated = aggregated.concat(items);
                            currentWebsiteItems = aggregated;
                        }
                        showWebsites(currentWebsiteItems);
                    } catch (e) {
                        addLog(`–û—à–∏–±–∫–∞ ${i + 1}: ${e.message}`, 'warning');
                    } finally {
                        activeController = null;
                    }
                }
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                setTimeout(hideProgress, 800);
                const okCount = (currentWebsiteItems || []).filter(i => (String(i.website||'').trim().length>0)).length;
                const missCount = (currentWebsiteItems || []).length - okCount;
                const summaryEl = document.getElementById('websitesSummary');
                if (interrupted) {
                    addLog(`–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ –ø—Ä–µ—Ä–≤–∞–Ω. –ù–∞–π–¥–µ–Ω–æ: ${okCount}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${missCount}`, 'warning');
                    if (summaryEl) {
                        summaryEl.textContent = `–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ –ø—Ä–µ—Ä–≤–∞–Ω: –Ω–∞–π–¥–µ–Ω–æ ${okCount}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${missCount}.`;
                        summaryEl.style.display = 'block';
                    }
                } else {
                    addLog(`–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω. –ù–∞–π–¥–µ–Ω–æ: ${okCount}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ: ${missCount}`, 'success');
                    if (summaryEl) {
                        summaryEl.textContent = `–ü–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω: –Ω–∞–π–¥–µ–Ω–æ ${okCount}, –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ${missCount}.`;
                        summaryEl.style.display = 'block';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ —Å–∞–π—Ç–∞–º–∏
                    if (Array.isArray(currentWebsiteItems) && currentWebsiteItems.length > 0) {
                        const organizations = currentWebsiteItems.map(item => ({
                            name: item.name,
                            website: item.website,
                            email: '',
                            address: ''
                        }));
                        await updateCache(location, 'websites', 'completed', organizations);
                    }
                }
                // –ö–Ω–æ–ø–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (–≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ)
                const extractBtn = document.getElementById('extractContactsBtn');
                if (extractBtn) {
                    extractBtn.style.display = 'inline-block';
                    extractBtn.disabled = !(Array.isArray(currentWebsiteItems) && currentWebsiteItems.length > 0);
                }
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —Å–∞–π—Ç–æ–≤: ${e.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(hideProgress, 1200);
            }
            finally {
                const findBtn = document.getElementById('findWebsitesBtn');
                const stopBtn = document.getElementById('stopWebsitesBtn');
                if (findBtn) findBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                activeProcess = null;
                activeController = null;
            }
        }

        function stopAllProcesses() {
            try {
                if (!activeProcess) {
                    addLog('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏', 'warning');
                    const stopBtn = document.getElementById('stopWebsitesBtn');
                    const fixedStopBtn = document.getElementById('fixedStopBtn');
                    if (stopBtn) stopBtn.disabled = true;
                    if (fixedStopBtn) {
                        fixedStopBtn.disabled = true;
                        fixedStopBtn.style.display = 'none';
                    }
                    return;
                }
                stopFinding = true;
                if (activeController) {
                    try { activeController.abort(); } catch {}
                }
                addLog('–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å...', 'warning');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
                processMsg = document.getElementById('processMessage');
                if (processMsg && activeProcess === 'contacts') {
                    processMsg.textContent = '‚èπÔ∏è –ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω...';
                }
            } catch {}
            const stopBtn = document.getElementById('stopWebsitesBtn');
            const fixedStopBtn = document.getElementById('fixedStopBtn');
            if (stopBtn) stopBtn.disabled = true;
            if (fixedStopBtn) {
                fixedStopBtn.disabled = true;
                fixedStopBtn.style.display = 'none';
            }
        }

        function showWebsites(items) {
            const section = document.getElementById('websitesSection');
            if (!Array.isArray(items)) items = [];
            const tbody = document.getElementById('websitesBody');
            tbody.innerHTML = '';
            items.forEach((it) => {
                const name = String(it.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const site = String(it.website || '').trim();
                const siteCell = site ? `<a href="${site}" target="_blank" rel="noopener noreferrer">${site}</a>` : '—Å–∞–π—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
                // –Ω–∞–π–¥—ë–º –∫–æ–Ω—Ç–∞–∫—Ç—ã, –µ—Å–ª–∏ —É–∂–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã
                let c = null;
                if (Array.isArray(currentContacts) && currentContacts.length > 0) {
                    c = currentContacts.find(x => String(x.name||'') === String(it.name||'')) || null;
                }
                const emailCell = c && c.email ? c.email : '';
                const addrCell = c && c.address ? c.address : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${name || '-'}</td><td>${siteCell}</td><td>${emailCell || '‚Äî'}</td><td>${addrCell || '‚Äî'}</td>`;
                tbody.appendChild(tr);
            });
            section.style.display = 'block';
            // –µ–¥–∏–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ª—é–±—ã—Ö —Å—Ç—Ä–æ–∫
            const exportBtn = document.getElementById('exportWebsitesExcelBtn');
            if (exportBtn) exportBtn.disabled = items.length === 0;
        }

        async function extractContactsSequential() {
            try {
                beginProcess('contacts');
                if (!Array.isArray(currentWebsiteItems) || currentWebsiteItems.length === 0) {
                    showModal('–ù–µ—Ç —Å–∞–π—Ç–æ–≤', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤.');
                    endProcess();
                    return;
                }
                const location = currentLocation || '';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –¥–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                const cacheStatus = await checkCacheStatus(location);
                if (cacheStatus && cacheStatus.location_match && cacheStatus.process_status.contacts_extracted) {
                    addLog(`–ö–æ–Ω—Ç–∞–∫—Ç—ã —É–∂–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –≤ –∫—ç—à–µ –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'success');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏–∑ –∫—ç—à–∞
                    if (currentCacheData && currentCacheData.organizations) {
                        const contacts = currentCacheData.organizations.filter(org => 
                            (org.email && org.email !== '') || (org.address && org.address !== '')
                        );
                        
                        if (contacts.length > 0) {
                            showContacts(contacts);
                            addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ –∫—ç—à–∞`, 'success');
                            endProcess();
                            return;
                        }
                    }
                }
                
                addLog('–ù–∞—á–∏–Ω–∞—é –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Å–∞–π—Ç–∞–º...', 'info');
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–∏—Å–∫–µ —Å–∞–π—Ç–æ–≤
                const summaryEl = document.getElementById('websitesSummary');
                if (summaryEl) {
                    summaryEl.style.display = 'none';
                    summaryEl.textContent = '';
                }
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                addLog('–ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω...', 'info');
                processMsg = document.getElementById('processMessage');
                if (processMsg) {
                    processMsg.style.display = 'block';
                    processMsg.textContent = 'üöÄ –ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω...';
                }
                showProgress();
                const total = currentWebsiteItems.length;
                const batchItems = currentWebsiteItems.map(it => ({ name: String(it.name||''), website: String(it.website||'') }));
                // –±—É–¥–µ–º –ø–æ—Å—ã–ª–∞—Ç—å –ø–∞—á–∫–∞–º–∏ –ø–æ 1 –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                currentContacts = [];
                activeProcess = 'contacts';
                stopFinding = false;
                activeController = null;
                let interrupted = false;
                for (let i = 0; i < batchItems.length; i++) {
                    if (stopFinding) { 
                        addLog('–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning'); 
                        interrupted = true;
                        break; 
                    }
                    const one = [batchItems[i]];
                    updateProgress(Math.round((i/Math.max(1,total))*90)+10, `–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤... ${i+1}/${total}`);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
                    processMsg = document.getElementById('processMessage');
                    if (processMsg) {
                        processMsg.textContent = `üöÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤... ${i+1}/${total}`;
                    }
                    
                    activeController = new AbortController();
                    const resp = await fetch('http://127.0.0.1:8001/extract-contacts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json; charset=utf-8', 'Accept': 'application/json; charset=utf-8' },
                        body: JSON.stringify({ location, items: one }),
                        signal: activeController.signal
                    });
                    if (!resp.ok) {
                        const txt = await resp.text().catch(()=> '');
                        addLog(`–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: HTTP ${resp.status}: ${txt}`, 'warning');
                        continue;
                    }
                    const data = await resp.json();
                    const got = Array.isArray(data.items) ? data.items : [];
                    if (got.length > 0) {
                        currentContacts.push(got[0]);
                    }
                    // –æ–±–Ω–æ–≤–∏–º —Ç–∞–±–ª–∏—Ü—É
                    showWebsites(currentWebsiteItems);
                    activeController = null;
                }
                updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
                processMsg = document.getElementById('processMessage');
                if (processMsg) {
                    processMsg.textContent = '‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!';
                }
                
                setTimeout(hideProgress, 800);
                const emailCount = currentContacts.filter(x => (x.email||'').trim()).length;
                const addressCount = currentContacts.filter(x => (x.address||'').trim()).length;
                const totalProcessed = currentContacts.length;
                const emailNotFound = totalProcessed - emailCount;
                const addressNotFound = totalProcessed - addressCount;
                
                if (interrupted) {
                    addLog(`–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–µ—Ä–≤–∞–Ω–æ: –Ω–∞–π–¥–µ–Ω–æ email=${emailCount}, –∞–¥—Ä–µ—Å–æ–≤=${addressCount}`, 'warning');
                    if (summaryEl) {
                        summaryEl.textContent = `–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–µ—Ä–≤–∞–Ω–æ: –Ω–∞–π–¥–µ–Ω–æ email=${emailCount}, –∞–¥—Ä–µ—Å–æ–≤=${addressCount}. –ù–µ –Ω–∞–π–¥–µ–Ω–æ: email=${emailNotFound}, –∞–¥—Ä–µ—Å–æ–≤=${addressNotFound}.`;
                        summaryEl.style.display = 'block';
                    }
                } else {
                    addLog(`–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –Ω–∞–π–¥–µ–Ω–æ email=${emailCount}, –∞–¥—Ä–µ—Å–æ–≤=${addressCount}`, 'success');
                    if (summaryEl) {
                        summaryEl.textContent = `–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –Ω–∞–π–¥–µ–Ω–æ email=${emailCount}, –∞–¥—Ä–µ—Å–æ–≤=${addressCount}. –ù–µ –Ω–∞–π–¥–µ–Ω–æ: email=${emailNotFound}, –∞–¥—Ä–µ—Å–æ–≤=${addressNotFound}.`;
                        summaryEl.style.display = 'block';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏
                    if (Array.isArray(currentContacts) && currentContacts.length > 0) {
                        const organizations = currentContacts.map(contact => ({
                            name: contact.name,
                            website: contact.website || '',
                            email: contact.email || '',
                            address: contact.address || ''
                        }));
                        await updateCache(location, 'contacts', 'completed', organizations);
                    }
                }
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤: ${e.message}`, 'error');
                updateProgress(0, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                setTimeout(hideProgress, 1200);
            } finally {
                endProcess();
                activeProcess = null;
                activeController = null;
            }
        }

        function exportWebsitesCsv() {
            try {
                const items = Array.isArray(currentWebsiteItems) ? currentWebsiteItems : [];
                if (items.length === 0) {
                    showModal('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ —Å–∞–π—Ç–æ–≤.');
                    return;
                }
                const bom = '\ufeff';
                const header = 'name,website\n';
                const esc = (v) => {
                    let s = String(v == null ? '' : v);
                    if (/[",\n]/.test(s)) s = '"' + s.replace(/"/g, '""') + '"';
                    return s;
                };
                const rows = items.map(it => `${esc(it.name||'')},${esc(it.website||'')}`).join('\n');
                const csv = bom + header + rows + '\n';
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const dlUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = `—Å–∞–π—Ç—ã_${currentLocation || '–≥–æ—Ä–æ–¥'}_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(dlUrl);
                document.body.removeChild(a);
                addLog('–≠–∫—Å–ø–æ—Ä—Ç —Å–∞–π—Ç–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω (CSV)', 'success');
            } catch (e) {
                addLog(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å–∞–π—Ç–æ–≤: ${e.message}`, 'error');
            }
        }

        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–≠–®–ï–ú =====
        
        let cacheStatus = null;
        let currentCacheData = null;

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∫—ç—à–∞ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
         */
        async function checkCacheStatus(location) {
            try {
                addLog(`–ü—Ä–æ–≤–µ—Ä—è—é –∫—ç—à –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'info');
                const response = await fetch(`http://127.0.0.1:8001/cache-status/${encodeURIComponent(location)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                cacheStatus = await response.json();
                currentCacheData = cacheStatus.cache_data;
                
                addLog(`–°—Ç–∞—Ç—É—Å –∫—ç—à–∞: ${cacheStatus.location_match ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`, 'info');
                addLog(`–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: ${cacheStatus.next_stage}`, 'info');
                
                if (cacheStatus.location_match && cacheStatus.organizations_count > 0) {
                    addLog(`–ù–∞–π–¥–µ–Ω–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ –∫—ç—à–µ: ${cacheStatus.organizations_count}`, 'info');
                }
                
                return cacheStatus;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—ç—à–∞: ${error.message}`, 'error');
                return null;
            }
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–∞–ø–∞
         */
        async function updateCache(location, stage, status, organizations = null) {
            try {
                const requestData = {
                    location: location,
                    stage: stage,
                    status: status
                };
                
                if (organizations) {
                    requestData.organizations = organizations;
                }
                
                addLog(`–û–±–Ω–æ–≤–ª—è—é –∫—ç—à: —ç—Ç–∞–ø ${stage}, —Å—Ç–∞—Ç—É—Å ${status}`, 'info');
                
                const response = await fetch('http://127.0.0.1:8001/cache-update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'Accept': 'application/json; charset=utf-8',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                addLog(`–ö—ç—à –æ–±–Ω–æ–≤–ª–µ–Ω: ${result.message}`, 'success');
                return true;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞: ${error.message}`, 'error');
                return false;
            }
        }

        /**
         * –û—á–∏—â–∞–µ—Ç –∫—ç—à –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
         */
        async function clearCache(location) {
            try {
                addLog(`–û—á–∏—â–∞—é –∫—ç—à –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'info');
                const response = await fetch(`http://127.0.0.1:8001/cache-clear/${encodeURIComponent(location)}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                addLog(`–ö—ç—à –æ—á–∏—â–µ–Ω: ${result.message}`, 'success');
                return true;
            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞: ${error.message}`, 'error');
                return false;
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
         */
        function loadCacheDataToUI() {
            if (!currentCacheData || !currentCacheData.organizations) {
                return;
            }
            
            const organizations = currentCacheData.organizations;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            if (organizations.length > 0) {
                const names = organizations.map(org => org.name).filter(name => name);
                if (names.length > 0) {
                    currentNames = names; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    showNames(names);
                    addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${names.length} –Ω–∞–∑–≤–∞–Ω–∏–π –∏–∑ –∫—ç—à–∞`, 'success');
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∞–π—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            const websites = organizations.filter(org => org.website && org.website !== '').map(org => ({
                name: org.name,
                website: org.website
            }));
            
            if (websites.length > 0) {
                currentWebsiteItems = websites; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                showWebsites(websites);
                addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${websites.length} —Å–∞–π—Ç–æ–≤ –∏–∑ –∫—ç—à–∞`, 'success');
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            const contacts = organizations.filter(org => 
                (org.email && org.email !== '') || (org.address && org.address !== '')
            );
            
            if (contacts.length > 0) {
                currentContacts = contacts; // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                showContacts(contacts);
                addLog(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${contacts.length} –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏–∑ –∫—ç—à–∞`, 'success');
            }
        }

        /**
         * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫—ç—à–∞
         */
        function getNextStageFromCache() {
            if (!cacheStatus) {
                return 'names';
            }
            
            return cacheStatus.next_stage;
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç–∞–ø –∑–∞–Ω–æ–≤–æ
         */
        function shouldExecuteStage(stage) {
            if (!cacheStatus) {
                return true;
            }
            
            const status = cacheStatus.process_status;
            
            switch (stage) {
                case 'names':
                    return !status.names_found || status.last_stage_status === 'interrupted';
                case 'websites':
                    return !status.websites_found || status.last_stage_status === 'interrupted';
                case 'contacts':
                    return !status.contacts_extracted || status.last_stage_status === 'interrupted';
                default:
                    return true;
            }
        }

        /**
         * –û—á–∏—â–∞–µ—Ç –∫—ç—à –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞
         */
        async function clearCacheForCurrentLocation() {
            const location = document.getElementById('locationInput').value.trim();
            if (!location) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä–æ—Ä—Ç–∞');
                return;
            }
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –¥–ª—è –≥–æ—Ä–æ–¥–∞ "${location}"?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–Ω–µ—Ç –ø–æ–∏—Å–∫ —Å –Ω—É–ª—è.`)) {
                const success = await clearCache(location);
                if (success) {
                    // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('namesSection').style.display = 'none';
                    document.getElementById('namesExportSection').style.display = 'none';
                    document.getElementById('websitesSection').style.display = 'none';
                    document.getElementById('websitesExportSection').style.display = 'none';
                    document.getElementById('contactsSection').style.display = 'none';
                    document.getElementById('contactsExportSection').style.display = 'none';
                    
                    // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                    currentNames = [];
                    currentWebsiteItems = [];
                    currentContacts = [];
                    cacheStatus = null;
                    currentCacheData = null;
                    
                    addLog(`–ö—ç—à –æ—á–∏—â–µ–Ω –¥–ª—è –≥–æ—Ä–æ–¥–∞: ${location}`, 'success');
                }
            }
        }

    </script>
</body>
</html>
